\documentclass[main]{subfiles}

\begin{document}

\section{Unbalanced Aggregated Conformal Prediction}
In this section, we present the proposed aggregation framework called unbalanced aggregated conformal prediction. We propose to aggregate conformal p-values across unbalanced data sources, where the number of sources and the size of each data source may vary. The classical TCP is employed to compute p-values for individual data sources and then these p-values are aggregated to obtain the final p-values. This aggregated predictor is named as Unbalanced Aggregated Conformal Predictor (uACP). 

%For illustration purpose, let us consider a binary classification problem, and 
Suppose we have a training dataset $Z$ and  external test data set $X$, or we randomly partition the given dataset into training ($80\%$) and external test set ($20\%$). The simple steps  for aggregated TCP, uACP, from multiple sources is as follows. It is also illustrated in Figure \ref{fig:uACP} and Algorithm \ref{algo:uACP}.
\begin{enumerate}

\item The training data set is randomly split into K parts (disjointly) with varying sizes. For example, Let $Z = \{ z_1 , ..., z_n \} $ be the data set, then we divide the dataset into $S_1, ..., S_K$ such that $Z = \bigcup_{i=1}^K S_i$, $k_i = |S_i|$ and $n = k_1+ ...+k_K$.

\item Compute TCP p-values using the algorithm $TCP(S_i, X)$ for each $S_i$, 

\item Aggregate the $K$, p-values, compute validity and efficiency.  

\item Repeat step 1 to step 3 with different values of K for $q$ times, each one is considered as a uACP. %and $k_i's$ say for $q$ times.

%\item Pairwise compare the $q$ uACP results obtained to see whether the number of sources or different size of the sources make any difference in validity or efficiency. %(this part is not clear yet).

\end{enumerate}

The results obtained for $q$ uACPS are then compared pairwise and are also compared with the pooled (whole) data and (balanced) equal sized partitions. In the following, we describe the study procedure (random sized or equal sized partition) and the parameters (the number and size of the sources) to be investigated in the result section. 

%In the following section, we show results when the procedure is applied to five different datasets. 

 \begin{algorithm}[H]
 \textbf{Input:}{ (training dataset:Z, test dataset:X, label set:Y, a nonconformity measure:$\mathcal{A})$}\\
 \textbf{Output:}{\textbf{ Aggregated p-values} }\\
 \textbf{Initialization\;}
 Unequal size partition: Partition training.data randomly and unequally into K parts, $S_1, ..., S_K$ ;\\ %such that $Z = \bigcup_{i=1}^K S_i$, $k_i = |S_i|$ and $n = k_1+ ...+k_K$, where n is size of the training.data \\
 \textbf{Steps\;}
 \For{each $S_i$,  $i \in \{ 1,...,K\} $ }{
 	\For{each observation $x_j \in X$}{
 		Compute p-values by using \textbf{TCP} algorithm:\\
 		 
  		$ PValues_i =  \textbf{TCP}(S_i, x_i, Y , \mathcal{A})$;\\
  	
  }
 }
 Aggregate $PValues_i$ from various sources into a set \textbf{p-values}
 \caption{Unbalanced Aggregated Conformal Predictor} \label{algo:uACP}
 \textbf{return \textbf{p-values}}
 \end{algorithm}
 
 \usetikzlibrary{arrows,shapes,positioning,shadows,trees}

\tikzset{
  basic/.style  = {draw, text width=2cm, drop shadow, font=\sffamily, rectangle},
  root/.style   = {basic, thin, align=center, 
                   fill=white!30, text width=5em},
  level 2/.style = {basic,  thin,align=center, fill=white!60,
                   text width=5em},
  level 3/.style = {basic, thin, align=left, fill=white!60, text width=5em}
}


\begin{center}
\begin{figure}

\begin{tikzpicture}[
  level 1/.style={sibling distance=40mm},
  edge from parent/.style={->,draw},
  >=latex]

% root of the the initial tree, level 1
\node[root] {Dataset}
% The first level, as children of the initial tree
  child {node[level 2,xshift=-100pt] (c1) {Training Data (80\%)}}
  child {node[level 3, xshift=50pt] (c2) {Test data (20\%)}};
  

% The second level, relatively positioned nodes
\begin{scope}[every node/.style={level 2}]
\node [below of = c1, xshift=-100pt, yshift=-30] (c11) {Training Data1};
\node [right of = c11, xshift=50pt] (c12) {Training Data2};
\node [right of = c12, xshift=100pt] (c13) {Training DataK};

%\node [below of = c11, yshift=-100] (m11) {Endpoint prediction probabilities using TCP};
%\node [below of = c12, yshift=-100] (m12) {Endpoint prediction probabilities using TCP};
%\node [below of = c13, yshift=-100] (m13) {Endpoint prediction probabilities using TCP};

\node [below of = c11, yshift=-100] (p11) {Estimation of p-values using TCP};
\node [below of = c12, yshift=-100] (p12) {Estimation of p-values using TCP};
\node [below of = c13, yshift=-100] (p13) {Estimation of p-values using TCP};

\node [below of = p12, xshift=30, yshift=-100, text width=8em] (a11) {\textbf{ aggregation of p-values } };

\end{scope}

% lines from each level 1 node to every one of its "children"
%\foreach \value in {1,2,3}
 % \draw[->] (c1.195) |- (c1\value.west);

  \draw[->] (c1)->(c11);
  \draw[->] (c1)->(c12);
  \draw[->] (c1)->(c13);
\path (c12) -- node[auto=false]{\ldots} (c13);

%\draw[->] (c11)->(m11);
%  \draw[->] (c12)->(m12);
%  \draw[->] (c13)->(m13);
 % \path (m12) -- node[auto=false]{\ldots} (m13);

\draw[->] (c11)->(p11);
  \draw[->] (c12)->(p12);
  \draw[->] (c13)->(p13);
  \path (p12) -- node[auto=false]{\ldots} (p13);
  
  \draw[->] (p11)->(a11);
  \draw[->] (p12)->(a11);
  \draw[->] (p13)->(a11);
  
  \draw[->] (c2)->(p11);
  \draw[->] (c2)->(p12);
  \draw[->] (c2)->(p13);
  
\end{tikzpicture}
\caption{Multi source aggregated TCP Algorithm} \label{fig:uACP}
\end{figure}

\end{center}

\end{document}
